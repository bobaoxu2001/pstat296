---
title: "296Data_SBBI"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# SBBI Raw Data for Capital Markets (2022_10_21)
```{r}
#install.packages("qpcR")
#install.packages("rgl")
```

```{r,echo=FALSE, result = 'hide',fig.show='hide',message=FALSE}
setwd("/Users/xuao/Documents/PSTAT296A/pstat296")
library(tsdl) 
library(forecast) 
library(tidyverse) 
library(astsa)
library(MASS) 
library(ggplot2) 
library(readxl)
library(ggfortify) 
library(forecast) 
library(GeneCycle) 
library(qpcR) 
require(TSA) 
#source("plot.roots.R")
```

```{r}
rm(list = ls())
```

# Import SBBI Raw Data for Capital Markets (2022_11_11)
# Renewed data for LT Govt Yield (20yr) from Jan-1926 to Sep-2022
```{r}
TR26_21 <- read_excel("/Users/xuao/Documents/PSTAT296A/pstat296/2022-11.11/SBBI Data for Capital Markets (2022_11_11).xlsx", sheet="Processed")
colnames(TR26_21) <- c("Observed Month", "Large Cap TR", "LT Govt TR 20 YR","IT Govt TR 5 YR","LT Corp TR 20 YR","T-Bill TR 30 DAY","US CPI/ INFLATION","LT Govt Yield 20 YEAR","IT Govt Yield 5 YEAR")
TR26_21 <- TR26_21 %>%
  filter(!row_number() %in% c(1:5)) %>%
  janitor::clean_names()
TR26_21 <- as.data.frame(sapply(TR26_21, as.numeric))
TR26_21 <- TR26_21 %>%
  mutate(observed_month = as.Date(observed_month,origin = "1899-12-30")) 
TR26_21
```

```{r}
Govt_20_Yield <- TR26_21[,c(1,8)]

Govt_20_Yield$yield_percentage <- round(Govt_20_Yield$lt_govt_yield_20_year*100, digits = 3)
#Govt_20_Yield$yield_percentage
```

```{r}
summary(Govt_20_Yield$yield_percentage)
```
```{r}
plot(Govt_20_Yield$yield_percentage,type="l",)
```
```{r}
# Since there is a big difference between the time before index 709 (1985.01) and after that
# So we choose to research in the data after index 709
# Divide it into train and test for nearly 90% and 10%
train <- Govt_20_Yield$yield_percentage[709:1116]
test <- Govt_20_Yield$yield_percentage[1117:1161]
#train set contains data points from 1985.01 to 2018.12, 408 points totally
#test set contains data points from 2019.01 and 2022.9, 45 points totally
```


```{r}
par(mfrow=c(2, 1))
tsdata <- ts(train, frequency = 12, start = c(1985,1,1)) 
c_test <-ts(test,start = c(2019,1),frequency = 12)
ts.plot(tsdata)
#ts.plot(c_test)
```

```{r}
hist(tsdata, main="Histogram",
xlab="date")
```
```{r}
acf(train, lag.max = 40, main = "")
```
To make the data stationary (variance/seasonality/trend),
,we use the Box-Cox transformation firstly
```{r}
# Box-Cox transformation:
t <- 1:length(tsdata)
bcTransform <- boxcox(tsdata ~ t, plotit=TRUE)
lambda <- bcTransform$x[which.max(bcTransform$y)]
tsdata.bc = (1/lambda)*(tsdata^lambda-1)
lambda
plot(tsdata.bc)
```

```{r}
# Plot and compare the two:
par(mfrow=c(2,3))
plot.ts(tsdata,xlab = "", main = "")
hist(tsdata, col = "light blue", xlab = "", main = "") 
qqnorm(tsdata, main = "", xlab = "")
qqline(tsdata, col = "red")
plot.ts(tsdata.bc,xlab = "", main = "")
hist(tsdata.bc, col = "light blue", xlab = "", main = "")
qqnorm(tsdata.bc, main = "", xlab = "")
qqline(tsdata.bc, col = "red")
```
```{r}
#y1 <- ts(as.ts(train),frequency = 12) 
decomp1 <- decompose(tsdata)
plot(decomp1)
decomp <- decompose(tsdata.bc)
plot(decomp)
```
From the comparisons, we could find that Box-Cox transformation makes it more normal
Since the Box-Cox plot does not contain neither has 0 nor 1 in the confidence interval for $\lambda$, we choose
$\lambda \approx$ 0.6262626 that maximizes the log-likelihood.

```{r}
# Deseasonlize:
tsdata.bc.12 <- diff(tsdata.bc, 12)
tsdata.bc.12.1 <- diff(tsdata.bc.12, 1)
tsdata.bc.12.1.1 <- diff(tsdata.bc.12.1, 1)
var(tsdata.bc)
var(tsdata.bc.12);
var(tsdata.bc.12.1); 
var(tsdata.bc.12.1.1)
```


```{r}
# Plot it for De-seasonlized Time Series :
par(mfrow=c(1, 1))
ts.plot(tsdata.bc.12.1, main="De-seasonlized Time Series",
ylab=expression(nabla[1]~nabla[12]~Y[t]))
abline(h=mean(tsdata.bc.12.1), lty=2)
```
### Model Identification

```{r}
#library(forecast)
#auto.arima(tsdata.bc.12.1,ic = c("aicc"),seasonal = T,stepwise = F,parallel = T)
```

```{r}
# Compare the ACF and PACF of tsdata.12.1
par(mfrow=c(2,3))
#acf(train, lag.max = 60, main = expression(U[t]))
#acf(tsdata.12, lag.max = 60, main = expression(nabla[12]~~U[t])) 
acf(tsdata.bc.12.1, lag.max = 60, main = expression(nabla[1]~nabla[12]~~U[t])) 
#pacf(train, lag.max = 60, main = "")
#pacf(tsdata.12, lag.max = 60, main = "")
pacf(tsdata.bc.12.1, lag.max = 60, main = "")
```
q  = 2, Q = 1 or 3
p = 2, P = 0
```{r}
# Calculate the AICc of possible models
a1 <- AICc(arima(tsdata.bc, order = c(0,1,0),
  seasonal = list(order = c(0,1,1), period = 12), method = "ML"))

a2 <- AICc(arima(tsdata.bc, order = c(0,1,0),
  seasonal = list(order = c(0,1,3), period = 12), method = "ML"))

a3 <- AICc(arima(tsdata.bc, order = c(0,1,0),
  seasonal = list(order = c(2,1,1), period = 12), method = "ML"))

a4 <- AICc(arima(tsdata.bc, order = c(0,1,0),
  seasonal = list(order = c(2,1,3), period = 12), method = "ML"))

a5 <- AICc(arima(tsdata.bc, order = c(0,1,1),
  seasonal = list(order = c(0,1,1), period = 12), method = "ML"))

a6 <- AICc(arima(tsdata.bc, order = c(0,1,1),
  seasonal = list(order = c(0,1,3), period = 12), method = "ML"))

a7 <- AICc(arima(tsdata.bc, order = c(0,1,1),
  seasonal = list(order = c(2,1,1), period = 12), method = "ML"))

a8 <- AICc(arima(tsdata.bc, order = c(0,1,1),
  seasonal = list(order = c(2,1,3), period = 12), method = "ML"))

a9 <- AICc(arima(tsdata.bc, order = c(0,1,2),
  seasonal = list(order = c(0,1,1), period = 12), method = "ML"))

a10 <- AICc(arima(tsdata.bc, order = c(0,1,2),
  seasonal = list(order = c(0,1,3), period = 12), method = "ML"))

a11 <- AICc(arima(tsdata.bc, order = c(0,1,2),
  seasonal = list(order = c(2,1,1), period = 12), method = "ML"))

a12 <- AICc(arima(tsdata.bc, order = c(0,1,2),
  seasonal = list(order = c(2,1,3), period = 12), method = "ML"))

b1 <- AICc(arima(tsdata.bc, order = c(1,1,0),
  seasonal = list(order = c(0,1,1), period = 12), method = "ML"))

b2 <- AICc(arima(tsdata.bc, order = c(1,1,0),
  seasonal = list(order = c(0,1,3), period = 12), method = "ML"))

b3 <- AICc(arima(tsdata.bc, order = c(1,1,0),
  seasonal = list(order = c(2,1,1), period = 12), method = "ML"))

b4 <- AICc(arima(tsdata.bc, order = c(1,1,0),
  seasonal = list(order = c(2,1,3), period = 12), method = "ML"))

b5 <- AICc(arima(tsdata.bc, order = c(1,1,1),
  seasonal = list(order = c(0,1,1), period = 12), method = "ML"))

b6 <- AICc(arima(tsdata.bc, order = c(1,1,1),
  seasonal = list(order = c(0,1,3), period = 12), method = "ML"))

#b7 <- AICc(arima(tsdata.bc, order = c(1,1,1),
  #seasonal = list(order = c(2,1,1), period = 12), method = "ML"))

#b8 <- AICc(arima(tsdata.bc, order = c(1,1,1),
  #seasonal = list(order = c(2,1,3), period = 12), method = "ML"))

b9 <- AICc(arima(tsdata.bc, order = c(1,1,2),
  seasonal = list(order = c(0,1,1), period = 12), method = "ML"))

b10 <- AICc(arima(tsdata.bc, order = c(1,1,2),
  seasonal = list(order = c(0,1,3), period = 12), method = "ML"))

#b11 <- AICc(arima(tsdata.bc, order = c(1,1,2),
  #seasonal = list(order = c(2,1,1), period = 12), method = "ML"))

b12 <- AICc(arima(tsdata.bc, order = c(1,1,2),
  seasonal = list(order = c(2,1,3), period = 12), method = "ML"))


c1 <- AICc(arima(tsdata.bc, order = c(2,1,0),
  seasonal = list(order = c(0,1,1), period = 12), method = "ML"))

c2 <- AICc(arima(tsdata.bc, order = c(2,1,0),
  seasonal = list(order = c(0,1,3), period = 12), method = "ML"))

c3 <- AICc(arima(tsdata.bc, order = c(2,1,0),
  seasonal = list(order = c(2,1,1), period = 12), method = "ML"))

c4 <- AICc(arima(tsdata.bc, order = c(2,1,0),
  seasonal = list(order = c(2,1,3), period = 12), method = "ML"))

c5 <- AICc(arima(tsdata.bc, order = c(2,1,1),
  seasonal = list(order = c(0,1,1), period = 12), method = "ML"))

c6 <- AICc(arima(tsdata.bc, order = c(2,1,1),
  seasonal = list(order = c(0,1,3), period = 12), method = "ML"))

c7 <- AICc(arima(tsdata.bc, order = c(2,1,1),
  seasonal = list(order = c(2,1,1), period = 12), method = "ML"))

c8 <- AICc(arima(tsdata.bc, order = c(2,1,1),
  seasonal = list(order = c(2,1,3), period = 12), method = "ML"))

c9 <- AICc(arima(tsdata.bc, order = c(2,1,2),
  seasonal = list(order = c(0,1,1), period = 12), method = "ML"))

c10 <- AICc(arima(tsdata.bc, order = c(2,1,2),
  seasonal = list(order = c(0,1,3), period = 12), method = "ML"))

c11 <- AICc(arima(tsdata.bc, order = c(2,1,2),
  seasonal = list(order = c(2,1,1), period = 12), method = "ML"))

c12 <- AICc(arima(tsdata.bc, order = c(2,1,2),
  seasonal = list(order = c(2,1,3), period = 12), method = "ML"))
```
```{r}
AICc_value <- rbind(a1,a2,a3,a4,a5,a6,a7,a8,a9,a10,a11,a12,b1,b2,b4,b5,b6,b9,b10,b12,c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12) 
#AICc_value
AICc_value[which.min(AICc_value), ]
m1 <- 
AICc_value2 <- rbind(a1,a2,a3,a4,a5,a6,a7,a8,a9,a10,a11,a12,b1,b2,b4,b5,b6,b9,b10,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12) 
AICc_value2[which.min(AICc_value2), ]
```

So one option is to use SARIMA $(2,1,0)*(0,1,1)_{12}$, and another one is to use $(0,1,2)*(0,1,1)_{12}$

## Model Selection

#### Model 1: $(2,1,0)*(0,1,1)_{12}$
```{r}
arima(tsdata.bc, order = c(2,1,0), seasonal = list(order = c(0,1,1), period = 12), method = "ML")
```
Set the coefficeint ar1 = 0 and then test. 
Only parameter for ar2 is significant. 
```{r}
polyroot(c(1, 0.0283))
```
Since it's outside of the unit circle, so it's staionary. 

Since it's AR models, then it is always invertible.


Then we move on to examine the residual of Model 1. 

The residual plot shows no trend, no seasonality, and no visible change of variance. Its mean is approximately zero.



```{r}
# Plot the residuals
fit1 <- arima(tsdata.bc, order = c(2,1,0),
              seasonal = list(order = c(0,1,1), period = 12), method = "ML") 
res1 <- residuals(fit1)
plot.ts(res1, xlab = "")
abline(h=mean(res1),col = "blue")
```

Then we move on to examine the residual of Model 1. 

The residual plot shows no trend, no seasonality, and no visible change of variance. Its mean is approximately zero.
```{r}
# Plot the histogram, Q-Q normal plot of the residual par(mfrow=c(1,2))
hist(res1, density = 20, breaks = 20,
col = "blue", xlab = "", prob = TRUE, main = "")
m1 <- mean(res1)
std1 <- sqrt(var(res1)) 
curve(dnorm(x,m1,std1),add = TRUE) 
qqnorm(res1,main = "", xlab = "")
qqline(res1, col = "blue")
# Plot the ACF and PACF of the residual
par(mfrow=c(1,2))
acf(res1,lag.max=240, main = "") 
pacf(res1,lag.max=240, main = "")
```
The histogram looks normal and center at zero. 

The majority of the data lies on the qqline.

White Noise?

#### Model 2: $(0,1,2)*(0,1,1)_{12}$
```{r}
arima(tsdata.bc, order = c(0,1,2), seasonal = list(order = c(0,1,1), period = 12), method = "ML")
```
Only parameter for ma2 is significant.

Since it's MA models, then it is always stationary.

```{r}
polyroot(c(1, 0.0430))
```

Since it's outside of unit circle, then it is invertible.

Then we move on to examine the residual of Model 2. 

The residual plot shows no trend, no seasonality, and no visible change of variance. Its mean is approximately zero.

```{r}
# Plot the residuals
fit2 <- arima(tsdata.bc, order = c(0,1,2),
              seasonal = list(order = c(0,1,1), period = 12), method = "ML") 
res2 <- residuals(fit2)
plot.ts(res2, xlab = "")
abline(h=mean(res2),col = "blue")
```
The residual plot shows no trend, no seasonality, and no visible change of variance.

Its mean is approximately zero.


```{r}
# Plot the histogram, Q-Q normal plot of the residual par(mfrow=c(1,2))
hist(res1, density = 20, breaks = 20,
col = "blue", xlab = "", prob = TRUE, main = "")
m2 <- mean(res2)
std2 <- sqrt(var(res2)) 
curve(dnorm(x,m2,std2),add = TRUE) 
qqnorm(res2,main = "", xlab = "")
qqline(res2, col = "blue")
# Plot the ACF and PACF of the residual
par(mfrow=c(1,2))
acf(res2,lag.max=60, main = "") 
pacf(res2,lag.max=60, main = "")
```
White Noise?

## Model Diagnostics

#### Model 1: $(2,1,0)*(0,1,1)_{12}$
```{r}
# Residual plots:
res1 <- residuals(fit1)
mean(res1); var(res1)
# layout(matrix(c(1, 1, 2, 3), 2, 2, byrow=T))
par(mfrow=c(1, 1))
ts.plot(res1, main="Fitted Residuals")
t1 <- 1:length(res1)
fit.res1 = lm(res1~ t1)
abline(fit.res1)
abline(h = mean(res1), col = "red")
```
```{r}
# ACF and PACF:
par(mfrow=c(1, 2))
acf(res1, main="Autocorrelation")
pacf(res1, main="Partial Autocorrelation")
```
Using lag = 20, do Box-Pierce, Box-Ljung, McLeod-Li tests.
df = h-p-q = 20-2=18
```{r}
sqrt(length(train))
```

```{r}
Box.test(res1, lag = 20, type = c("Box-Pierce"), fitdf = 2)
```


```{r}
Box.test(res1, lag = 20, type = c("Ljung-Box"), fitdf = 2)
```

```{r}
Box.test(res1^2, lag = 20, type = c("Ljung-Box"), fitdf = 0)
```

```{r}
ar(res1,aic=TRUE,order.max=NULL, mehod = c("yule-walker"))
```


Then, We check normality assumption.# Test for normality of residuals
```{r}
shapiro.test(res1)
```
```{r}
# Histogram and QQ-plot:
par(mfrow=c(1,2))
hist(res1,main = "Histogram")
qqnorm(res1)
qqline(res1,col ="blue")
```

#### Model 2: $(0,1,2)*(0,1,1)_{12}$
```{r}
# Residual plots:
res2 <- residuals(fit2)
mean(res2); var(res2)
# layout(matrix(c(1, 1, 2, 3), 2, 2, byrow=T))
par(mfrow=c(1, 1))
ts.plot(res2, main="Fitted Residuals")
t2 <- 1:length(res2)
fit.res2 = lm(res2~ t2)
abline(fit.res2)
abline(h = mean(res2), col = "red")
```
```{r}
# ACF and PACF:
par(mfrow=c(1, 2))
acf(res2, main="Autocorrelation")
pacf(res2, main="Partial Autocorrelation")
```
Using lag = 20, do Box-Pierce, Box-Ljung, McLeod-Li tests.
```{r}
Box.test(res2, lag = 20, type = c("Box-Pierce"), fitdf = 2)
```


```{r}
Box.test(res2, lag = 20, type = c("Ljung-Box"), fitdf = 2)
```

```{r}
Box.test(res2^2, lag = 20, type = c("Ljung-Box"), fitdf = 0)
```

```{r}
ar(res2,aic=TRUE,order.max=NULL, mehod = c("yule-walker"))
```

Then, We check normality assumption.# Test for normality of residuals
```{r}
shapiro.test(res2)
```

```{r}
# Histogram and QQ-plot:
par(mfrow=c(1,2))
hist(res2,main = "Histogram")
qqnorm(res2)
qqline(res2,col ="blue")
```


```{r}
fit.1<-arima(tsdata, order = c(2,1,0),
seasonal = list(order = c(0,1,1), period = 12), method = "ML")
# Create confidence interval
pred.tr <- predict(fit.1, n.ahead = 93)
U.tr = pred.tr$pred + 2*pred.tr$se
L.tr = pred.tr$pred - 2*pred.tr$se
# Forecast on original data
plot.ts(tsdata, xlim = c(1984,2022), ylim = c(0,13)) 
lines(U.tr, col = "blue", lty = "dashed")
lines(L.tr, col = "blue", lty = "dashed") 
points(pred.tr$pred,col = "red", pch = 1) 
```
```{r}
# Zoom in graph
par(mfrow=c(1,2))
plot.ts(tsdata, xlim = c(2015,2022), ylim = c(1,5))
lines(U.tr, col = "blue", lty = "dashed")
lines(L.tr, col = "blue", lty = "dashed") 
points(pred.tr$pred,col = "red", pch = 1) 
```

```{r}
# Forecast with test dataset
plot.ts(c_test, xlim = c(2015,2022), ylim = c(1,5))
lines(U.tr, col = "blue", lty = "dashed")
lines(L.tr, col = "blue", lty = "dashed")
points(pred.tr$pred,col = "red", pch = 1)
points(test,col = "slategrey", pch = 20)
```



